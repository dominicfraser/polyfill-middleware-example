/* eslint-disable import/no-extraneous-dependencies */
const fs = require('fs');
const path = require('path');

const { getUserAgentRegExp } = require('browserslist-useragent-regexp');

// Produce a Set similar to [promises, fetch, symbols]
function getFeatureArray() {
  const source = path.join(__dirname, '..', 'src', 'index.js');
  const lines = fs.readFileSync(source).toString().split('\n');
  const features = lines
    .map((line) => /.* caniuse: (.*)/.exec(line))
    .filter((res) => res !== null)
    .map((res) => res[1])
    .filter((feat) => feat !== 'undefined');
  return [...new Set(features)]; // Dedupe
}

// Produce a regex of all user agents that DO support the given features
const uAsNotNeedingPolyfillSupport = getUserAgentRegExp({
  browsers: getFeatureArray()
    .map((feat) => `supports ${feat}`)
    .join(' and '),
  allowHigherVersions: true,
});

process.stdout.write(
  `/* autogenerated */ module.exports = ${uAsNotNeedingPolyfillSupport};`,
);
